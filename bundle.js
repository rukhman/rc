(()=>{const e=indexedDB.open("db",1);let t=0,o=0,n=null,s=document.getElementById("photoInput");function r(e,t,n,s,r=!1){const l=document.createElement("div");l.style.position="absolute",l.style.width="7px",l.style.height="7px",l.style.top="-8px",l.style.right="3px",l.style.background="black",l.style.borderRadius="50%",l.style.cursor="pointer",l.title="Изменить",l.classList.add("editButton");const c=document.createElement("div");c.style.position="absolute",c.style.width="7px",c.style.height="7px",c.style.top="-8px",c.style.right="-5px",c.style.background="red",c.style.borderRadius="50%",c.style.cursor="pointer",c.title="Удалить",c.classList.add("delButton");const i=document.createElement("div");i.style.position="relative",i.id=e,i.classList.add("butWrap"),i.style.position="absolute",i.style.zIndex=1e3;let a=document.createElement("input");a.style.color="white",a.style.cursor="pointer",a.style.borderRadius="5px",a.style.border="1px solid #999",a.type="button",a.value=t??"КНОПКА № "+e,a.setAttribute("on",r),a.style.backgroundColor="true"===a.getAttribute("on")?"red":"green",i.appendChild(l),i.appendChild(c),i.appendChild(a),document.body.append(i);let d=document.body.getBoundingClientRect(),u=document.documentElement.clientWidth/2,m=document.documentElement.clientHeight/2;i.style.left=Math.abs(d.x)+u+"px",i.style.top=Math.abs(d.y)+m+"px",n&&(i.style.left=n+"px"),s&&(i.style.top=s+"px");const g=document.getElementById(e);g.ondragstart=function(){return!1},g.onmousedown=function(e){if(o=new Date,e.target.classList.contains("editButton")){const t=e.currentTarget.querySelector("input"),o=prompt("Введите название кнопки",t.getAttribute("value"));return void(o&&t.setAttribute("value",o))}if(e.target.classList.contains("delButton"))return void document.getElementById(e.currentTarget.id).remove();let t=e.clientX-g.getBoundingClientRect().left,n=e.clientY-g.getBoundingClientRect().top;function s(e,o){g.style.left=e-t+"px",g.style.top=o-n+"px"}function r(e){s(e.pageX,e.pageY)}s(e.pageX,e.pageY),document.addEventListener("mousemove",r),g.onmouseup=function(e){const t=g.querySelector("input");if(Math.abs(o.getTime()-(new Date).getTime())<160){let e="true"===t.getAttribute("on");g.querySelector("input").setAttribute("on",e?"false":"true"),e="true"===t.getAttribute("on"),t.style.backgroundColor=e?"red":"green",function(e,t){const o=e.id;console.log(o);const n=e.querySelector("input").getAttribute("value");console.log(n),console.log(t)}(g,e)}document.removeEventListener("mousemove",r),g.onmouseup=null}}}function l(){const t=e.result.transaction(["images"],"readwrite").objectStore("images").getAll();t.onsuccess=e=>{const o=t.result;let s=+Array.from(document.getElementById("versions").options).filter((e=>e.selected)).map((e=>e.value))?.[0];const l=o.find((e=>e.id===s));c(),localStorage.setItem("version",s),l&&(n=l?.img,document.getElementById("preview").src=l?.img||"",(l.buttons||[]).forEach((e=>{r(e.id,e.name,e.offsetLeft,e.offsetTop,e.isOn)})))},t.onerror=e=>console.log(e.target.error.message)}function c(){const e=document.getElementsByClassName("butWrap");for(document.getElementById("preview").src="";e.length>0;)e[e.length-1].remove()}e.onupgradeneeded=e=>{e.target.result.createObjectStore("images",{keyPath:"id",autoIncrement:!0})},e.onsuccess=t=>{const o=e.result.transaction(["images"],"readwrite").objectStore("images").getAll();o.onsuccess=e=>{const t=o.result,n=document.getElementById("versions");n.options[n.options.length]=new Option("Не выбрано",-1),t.forEach((e=>{n.options[n.options.length]=new Option(e.name,e.id)})),n.value=localStorage.getItem("version")??-1,l()},o.onerror=e=>console.log(e.target.error.message)},e.onerror=function(){console.error("Error",openRequest.error)},document.getElementById("save").onclick=async()=>{const t=document.getElementById("versions");let o="Версия №";-1!=+t.value&&(o=Array.from(t.options).filter((e=>e.selected))[0].text);const s=prompt("Введите название сохраняемой версии",o);s&&function(t){const o=e.result.transaction(["images"],"readwrite").objectStore("images"),s=[],r=document.getElementsByClassName("butWrap");for(let e=0;e<r.length;e++){const t=r[e];s.push({id:+t.id,name:t.querySelector("input").value,offsetLeft:t.offsetLeft,offsetTop:t.offsetTop,isOn:t.querySelector("input").getAttribute("on")})}const l={name:t,img:n,buttons:s},c=document.getElementById("versions"),i=+c.value;if(-1===i){const e=o.add(l);e.onsuccess=o=>{const n=+e.result;c.options[c.options.length]=new Option(t,n),c.value=n,alert(`Создана новая запись с именем "${t}" и ID ${n}`)}}else{const e=o.get(i);e.onsuccess=t=>{if(e.result){const t={...e.result,...l};o.put(t)}}}}(s)},s.onchange=async e=>{!function(e){const t=new FileReader;t.readAsDataURL(e.target.files[0]),t.addEventListener("load",(function(){n=t.result,document.getElementById("preview").src=t.result}))}(e)},document.getElementById("addButton").addEventListener("click",(()=>{const e=document.getElementsByClassName("butWrap"),o=[];for(let t=0;t<e.length;t++)o.push(+e[t].id);t=o.length?Math.max(...o):0,r(++t)})),document.getElementById("reset").addEventListener("click",(e=>{confirm("Очистить базу данных?")&&(indexedDB.deleteDatabase("db"),localStorage.clear(),location.reload())})),document.getElementById("deleteButton").addEventListener("click",(t=>{if(confirm("Удалить текущую версию?")){const t=e.result.transaction(["images"],"readwrite").objectStore("images"),o=document.getElementById("versions"),n=+o.value;-1===n?alert("так делать нельзя, выбери другую версию"):(t.delete(+n),c(),o.options[o.selectedIndex].remove(),localStorage.setItem("version",-1))}})),document.getElementById("versions").addEventListener("change",(e=>{l()})),document.getElementById("export").onclick=async()=>{const t=prompt("Введите имя файла");var o;t&&(o=e.result,new Promise(((e,t)=>{const n={};if(0===o.objectStoreNames.length)e(JSON.stringify(n));else{const s=o.transaction(o.objectStoreNames,"readonly");s.addEventListener("error",t);for(const t of o.objectStoreNames){const r=[];s.objectStore(t).openCursor().addEventListener("success",(s=>{const l=s.target.result;l?(r.push(l.value),l.continue()):(n[t]=r,o.objectStoreNames.length===Object.keys(n).length&&e(JSON.stringify(n)))}))}}}))).then((e=>{const o=new Blob([e],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(o,t);else{const e=window.document.createElement("a");e.href=window.URL.createObjectURL(o),e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e)}})).catch((e=>{console.error("Something went wrong during export:",e)}))},document.getElementById("import").addEventListener("change",(()=>{const t=new FileReader;t.readAsText(document.getElementById("import").files[0]),t.addEventListener("load",(function(){const o=t.result;var n,s;(n=e.result,s=o,new Promise(((e,t)=>{const o=n.transaction(n.objectStoreNames,"readwrite");o.addEventListener("error",t);var r=JSON.parse(s);for(const t of n.objectStoreNames){let n=0;for(const s of r[t])o.objectStore(t).add(s).addEventListener("success",(()=>{n++,n===r[t].length&&(delete r[t],0===Object.keys(r).length&&e())}))}}))).then((e=>{setTimeout((()=>{location.reload()}),3500)})).catch((e=>{console.error("Something went wrong during export:",e)}))}))}))})();