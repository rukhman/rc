(()=>{const e=indexedDB.open("db",1);let t=0,o=0,n=null,s=document.getElementById("photoInput");function r(e,t,n,s,r=!1){const l=document.createElement("div");l.style.position="absolute",l.style.width="7px",l.style.height="7px",l.style.top="-8px",l.style.right="3px",l.style.background="black",l.style.borderRadius="50%",l.style.cursor="pointer",l.title="Изменить",l.classList.add("editButton");const i=document.createElement("div");i.style.position="absolute",i.style.width="7px",i.style.height="7px",i.style.top="-8px",i.style.right="-5px",i.style.background="red",i.style.borderRadius="50%",i.style.cursor="pointer",i.title="Удалить",i.classList.add("delButton");const c=document.createElement("div");c.style.position="relative",c.id=e,c.classList.add("butWrap"),c.style.position="absolute",c.style.position="absolute",c.style.zIndex=1e3;let d=document.createElement("input");d.style.color="white",d.style.cursor="pointer",d.type="button",d.value=t??"КНОПКА № "+e,d.setAttribute("on",r),d.style.backgroundColor="true"===d.getAttribute("on")?"red":"green",c.appendChild(l),c.appendChild(i),c.appendChild(d),document.body.append(c),n&&(c.style.left=n+"px"),s&&(c.style.top=s+"px");const a=document.getElementById(e);a.ondragstart=function(){return!1},a.onmousedown=function(e){if(o=new Date,e.target.classList.contains("editButton")){const t=e.currentTarget.querySelector("input"),o=prompt("Введите название кнопки",t.getAttribute("value"));return void(o&&t.setAttribute("value",o))}if(e.target.classList.contains("delButton"))return void document.getElementById(e.currentTarget.id).remove();let t=e.clientX-a.getBoundingClientRect().left,n=e.clientY-a.getBoundingClientRect().top;function s(e,o){a.style.left=e-t+"px",a.style.top=o-n+"px"}function r(e){s(e.pageX,e.pageY)}s(e.pageX,e.pageY),document.addEventListener("mousemove",r),a.onmouseup=function(e){const t=a.querySelector("input");if(Math.abs(o.getTime()-(new Date).getTime())<160){let e="true"===t.getAttribute("on");a.querySelector("input").setAttribute("on",e?"false":"true"),e="true"===t.getAttribute("on"),t.style.backgroundColor=e?"red":"green",function(e,t){const o=e.id;console.log(o);const n=e.querySelector("input").getAttribute("value");console.log(n),console.log(t)}(a,e)}document.removeEventListener("mousemove",r),a.onmouseup=null}}}function l(){const t=e.result.transaction(["images"],"readwrite").objectStore("images").getAll();t.onsuccess=e=>{const o=t.result;let n=+Array.from(document.getElementById("versions").options).filter((e=>e.selected)).map((e=>e.value))?.[0];const s=o.find((e=>e.id===n));i(),localStorage.setItem("version",n),s&&(document.getElementById("preview").src=s?.img||"",(s.buttons||[]).forEach((e=>{r(e.id,e.name,e.offsetLeft,e.offsetTop,e.isOn)})))},t.onerror=e=>console.log(e.target.error.message)}function i(){const e=document.getElementsByClassName("butWrap");for(document.getElementById("preview").src="";e.length>0;)e[e.length-1].remove()}e.onupgradeneeded=e=>{e.target.result.createObjectStore("images",{keyPath:"id",autoIncrement:!0})},e.onsuccess=t=>{const o=e.result.transaction(["images"],"readwrite").objectStore("images").getAll();o.onsuccess=e=>{console.log("onsuccess");const t=o.result,n=document.getElementById("versions");n.options[n.options.length]=new Option("Не выбрано",-1),t.forEach((e=>{n.options[n.options.length]=new Option(e.name,e.id)})),n.value=localStorage.getItem("version")??-1,l()},o.onerror=e=>console.log(e.target.error.message)},e.onerror=function(){console.error("Error",openRequest.error)},document.getElementById("save").onclick=async()=>{const t=document.getElementById("versions");let o="Версия №";-1!=+t.value&&(o=Array.from(t.options).filter((e=>e.selected))[0].text);const s=prompt("Введите название сохраняемой версии",o);s&&function(t){const o=e.result.transaction(["images"],"readwrite").objectStore("images"),s=[],r=document.getElementsByClassName("butWrap");for(let e=0;e<r.length;e++){const t=r[e];s.push({id:+t.id,name:t.querySelector("input").value,offsetLeft:t.offsetLeft,offsetTop:t.offsetTop,isOn:t.querySelector("input").getAttribute("on")})}const l={name:t,img:n,buttons:s},i=document.getElementById("versions"),c=+i.value;if(-1===c){const e=o.add(l);e.onsuccess=o=>{const n=+e.result;i.options[i.options.length]=new Option(t,n),i.value=n,alert(`Создана новая запись с именем "${t}" и ID ${n}`)}}else{const e=o.get(c);e.onsuccess=t=>{if(e.result){const t={...e.result,...l};o.put(t)}}}}(s)},s.onchange=async e=>{!function(e){const t=new FileReader;t.readAsDataURL(e.target.files[0]),t.addEventListener("load",(function(){n=t.result,document.getElementById("preview").src=t.result}))}(e)},document.addEventListener("DOMContentLoaded",(()=>{})),document.getElementById("addButton").addEventListener("click",(()=>{r(++t)})),document.getElementById("reset").addEventListener("click",(e=>{confirm("Очистить базу данных?")&&(indexedDB.deleteDatabase("db"),localStorage.clear(),location.reload())})),document.getElementById("deleteButton").addEventListener("click",(t=>{if(confirm("Удалить текущую версию?")){const t=e.result.transaction(["images"],"readwrite").objectStore("images"),o=document.getElementById("versions"),n=+o.value;-1===n?alert("так делать нельзя, выбери другую версию"):(t.delete(+n),i(),o.options[o.selectedIndex].remove(),localStorage.setItem("version",-1))}})),document.getElementById("versions").addEventListener("change",(e=>{l()})),document.getElementById("export").onclick=async()=>{const t=prompt("Введите имя файла");t&&exportToJson(e.result).then((e=>{const o=new Blob([e],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)console.log("Exported JSON string:",e),window.navigator.msSaveBlob(o,t);else{const e=window.document.createElement("a");e.href=window.URL.createObjectURL(o),e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e)}})).catch((e=>{console.error("Something went wrong during export:",e)}))},document.getElementById("import").addEventListener("change",(()=>{const t=new FileReader;t.readAsText(document.getElementById("import").files[0]),t.addEventListener("load",(function(){const o=t.result;console.log(o),importFromJson(e.result,o).then((e=>{console.log("Exported JSON string:",e),setTimeout((()=>{location.reload()}),500)})).catch((e=>{console.error("Something went wrong during export:",e)}))}))}))})();